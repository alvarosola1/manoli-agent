<!DOCTYPE html>
<html>
<head>
    <title>Agente Browser Web - Chat</title>
    <style>
        html, body {
            /* 1) Hacer que todo ocupe la ventana del navegador */
            margin: 0;
            padding: 0;
            height: 100%;
        }
        body {
            font-family: sans-serif;
            background-color: #f5f5f5;
            display: flex; 
            flex-direction: column; 
        }

        /* El contenedor principal que ocupe toda la pantalla */
        .container {
            flex: 1; /* Para que ocupe todo el espacio vertical disponible */
            display: flex; 
            flex-direction: column; 
            max-width: 1200px; /* Ajusta si quieres más ancho */
            width: 100%;
            margin: 0 auto; /* Centra horizontalmente */
            background-color: #fff; 
            border: 1px solid #ccc; 
            border-radius: 5px;
        }
        header {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        h1 {
            margin: 0;
        }

        /* Formulario y chat contenedor */
        #prompt-form {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-top: 1px solid #ccc;
        }
        #prompt-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #submit-button {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            background-color: #007BFF;
            color: white;
        }
        #submit-button:hover:enabled {
            background-color: #0056b3;
        }
        #submit-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Contenedor del chat */
        #chat-container {
            flex: 1; /* Ocupa todo el espacio vertical sobrante */
            padding: 10px;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            background-color: #fafafa;
        }

        .user-message, .agent-message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            word-wrap: break-word;
            max-width: 80%;
        }
        .user-message {
            background-color: #DCF8C6; 
            align-self: flex-end; 
        }
        .agent-message {
            background-color: #ECECEC; 
            align-self: flex-start; 
        }
        .video-container {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .video-container video {
            width: 100%;
            height: auto;
            display: block;
        }
        .agent-response-area {
            margin-top: 10px;
        }
        .agent-log-area {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            background: #fefefe;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Spinner (circulito de carga) */
        #loading-overlay {
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            display: none; /* Por defecto oculto */
            align-items: center;
            justify-content: center;
            z-index: 9999; 
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007BFF;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body>
    <!-- Capa overlay para mostrar el spinner -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <header>
            <h1>Agente Browser Web - Chat</h1>
        </header>

        <div id="chat-container">
            {% if conversation_history %}
                {% for item in conversation_history %}
                    {% if item.role == 'user' %}
                        <div class="user-message">
                            <strong>Usuario:</strong> {{ item.content }}
                        </div>
                    {% elif item.role == 'agent' %}
                        <div class="agent-message">
                            <strong>Agente:</strong>
                            <div class="agent-response-area">
                                {% if item.response_text %}
                                    <p>{{ item.response_text }}</p>
                                {% endif %}
                                {% if item.video_url %}
                                    <div class="video-container">
                                        <video controls>
                                            <source src="{{ item.video_url }}" type="video/webm">
                                            Tu navegador no soporta el tag de video.
                                        </video>
                                    </div>
                                {% endif %}
                                {% if item.log_lines and item.log_lines|length > 0 %}
                                    <div class="agent-log-area">
                                        {% for log_line in item.log_lines %}
                                            <div>{{ log_line }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <form id="prompt-form" action="/ejecutar_agente" method="post">
            <input type="text" id="prompt-input" name="prompt_usuario" placeholder="Escribe aquí tu prompt..." required>
            <button id="submit-button" type="submit">Enviar</button>
        </form>
    </div>

    <script>
        // Referencias a elementos
        const promptForm = document.getElementById('prompt-form');
        const submitButton = document.getElementById('submit-button');
        const loadingOverlay = document.getElementById('loading-overlay');
        const chatContainer = document.getElementById('chat-container');

        // 1) Hacer scroll automático al final
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        // Llamar al cargar la página
        scrollToBottom();

        // 2) Al enviar el form, mostrar spinner y desactivar botón
        promptForm.addEventListener('submit', function() {
            // Mostrar overlay
            loadingOverlay.style.display = 'flex';
            // Desactivar botón
            submitButton.disabled = true;
        });

        // 3) Para reactivar el botón y ocultar overlay cuando la respuesta se reciba,
        //    puedes usar un "turbo" o "fetch" en AJAX. Pero con un <form> normal,
        //    se recarga la página. Necesitaríamos un approach en AJAX o WebSocket
        //    si quieres reactivarlo sin recargar. 
        //
        //    *Si la página se recarga*, el overlay desaparece automáticamente,
        //    pues es un nuevo HTML. El scroll se llamará de nuevo en la
        //    onload, etc.

        // 4) Forzar scroll al final tras un repaint
        //    con setTimeout para asegurar que el DOM ya haya renderizado
        window.onload = function() {
            setTimeout(() => {
                scrollToBottom();
            }, 100);
        };
    </script>
</body>
</html>